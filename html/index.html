<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç¥ GM æŒ‡ä»¤ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .menu {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .menu-btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sub-menu {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .sub-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-btn:hover {
            background: #667eea;
            color: white;
        }

        .sub-btn.active {
            background: #667eea;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 2px solid #667eea;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .command-text {
            background: #fff;
            padding: 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            color: #333;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .copy-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 10px;
        }

        /* å³ä¸Šè§’çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 180px;
        }

        .status-indicator .status-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .status-indicator .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-weight: bold;
            color: #333;
        }

        .status-value {
            display: inline-block;
            margin-left: 8px;
        }

        .status-disconnected {
            color: #dc3545;
        }

        .status-connected {
            color: #28a745;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .container {
                padding: 20px;
                margin-top: 80px;
            }

            h1 {
                font-size: 24px;
            }

            .menu {
                flex-direction: column;
                gap: 10px;
            }

            .menu-btn {
                font-size: 16px;
                padding: 12px;
            }

            .status-indicator {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                padding: 10px 15px;
                font-size: 12px;
            }

            .status-indicator .status-item {
                font-size: 12px;
            }
        }

        .execute-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #28a745;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .execute-btn:hover {
            background: #218838;
        }

        .execute-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* é€‰æ‹©è¾“å…¥æ¡†æ ·å¼ */
        .select-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .select-input:hover {
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .select-input.active {
            border-color: #764ba2;
        }

        .select-input .placeholder {
            color: #999;
        }

        .select-input .value {
            color: #333;
        }

        .select-input .arrow {
            transition: transform 0.3s;
        }

        .select-input.active .arrow {
            transform: rotate(180deg);
        }

        /* é€‰æ‹©é¢æ¿ */
        .select-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.2s;
        }

        .select-panel.active {
            display: flex;
            flex-direction: column;
        }

        .select-panel-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        /* å›ºå®šæœç´¢æ  - æ¯›ç»ç’ƒæ•ˆæœ */
        .panel-search-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            padding: 15px;
        }

        .panel-search-header input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .panel-search-header input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* é€‰é¡¹åˆ—è¡¨ */
        .panel-options {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .panel-option {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .panel-option:hover {
            background: #f0f0ff;
            border-color: #667eea;
        }

        .panel-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .panel-option.hidden {
            display: none;
        }

        /* é¢æ¿åº•éƒ¨æŒ‰é’® */
        .panel-footer {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .panel-footer button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-footer .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .panel-footer .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .panel-footer .cancel-btn {
            background: #e0e0e0;
            color: #666;
        }

        .panel-footer .cancel-btn:hover {
            background: #d0d0d0;
        }

        /* ç©å®¶æŒ‡ä»¤å¹¿åœºæ ·å¼ */
        .community-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .command-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .command-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .command-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .command-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .command-card-category {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .command-card-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .command-card-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
            margin-bottom: 12px;
            max-height: 80px;
            overflow-y: auto;
            word-break: break-all;
        }

        .command-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .command-card-info {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #999;
        }

        .command-card-actions {
            display: flex;
            gap: 10px;
        }

        .command-card-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .like-btn {
            background: #fff;
            border: 1px solid #667eea !important;
            color: #667eea;
        }

        .like-btn:hover {
            background: #667eea;
            color: white;
        }

        .use-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .use-btn:hover {
            transform: scale(1.05);
        }

        .upload-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .upload-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .upload-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-form select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-form select:focus {
            outline: none;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="status-indicator">
        <div class="status-item">
            <span class="status-label">æœåŠ¡å™¨:</span>
            <span id="server-status" class="status-value status-disconnected">æœªè¿æ¥</span>
        </div>
        <div class="status-item">
            <span class="status-label">åœ¨çº¿:</span>
            <span id="online-count" class="status-value">0äºº</span>
        </div>
    </div>

    <div class="container">
        <h1>âš”ï¸ åŸç¥ GM æŒ‡ä»¤ç”Ÿæˆå™¨</h1>

        <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
        <div id="user-info-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: white;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">ğŸ‘¤</span>
                <span style="font-weight: 600;">æ¬¢è¿ï¼Œ<span id="current-username">åŠ è½½ä¸­...</span></span>
            </div>
            <button onclick="logout()" style="padding: 8px 20px; background: rgba(255,255,255,0.2); border: 1px solid white; border-radius: 6px; color: white; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                ç™»å‡º
            </button>
        </div>

        <!-- ä¸»èœå• -->
        <div class="menu">
            <button class="menu-btn active" onclick="showSection('items')">ç‰©å“ç”Ÿæˆ</button>
            <button class="menu-btn" onclick="showSection('quest')">ä»»åŠ¡</button>
            <button class="menu-btn" onclick="showSection('custom')">è‡ªå®šä¹‰æŒ‡ä»¤</button>
            <button class="menu-btn" onclick="showSection('community')">ç©å®¶æŒ‡ä»¤å¹¿åœº</button>
        </div>

        <!-- UIDç®¡ç†åŒºåŸŸ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e0e0e0;">
            <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">ğŸ® UIDç®¡ç†</h3>

            <!-- å·²éªŒè¯çš„UIDåˆ—è¡¨ -->
            <div id="verified-uids-list" style="margin-bottom: 20px;">
                <label style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">å·²éªŒè¯çš„UIDï¼š</label>
                <div id="uids-container" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px;">
                    <div style="color: #999; font-size: 14px;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å½“å‰ä½¿ç”¨çš„UID -->
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #333;">å½“å‰ä½¿ç”¨çš„UIDï¼ˆç”¨äºæ‰§è¡ŒæŒ‡ä»¤ï¼‰ï¼š</label>
                <select id="player-uid" onchange="savePlayerUid()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    <option value="">è¯·é€‰æ‹©ä¸€ä¸ªUID</option>
                </select>
            </div>

            <!-- æ·»åŠ æ–°UIDåŒºåŸŸ -->
            <div style="background: white; padding: 15px; border-radius: 8px; border: 2px dashed #ddd;">
                <h4 style="margin-bottom: 10px; color: #666; font-size: 16px;">â• æ·»åŠ æ–°UID</h4>
                <div class="form-group" style="margin-bottom: 10px;">
                    <input type="number" id="new-uid-input" placeholder="è¯·è¾“å…¥è¦æ·»åŠ çš„UID" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                </div>

                <div class="form-group" id="verification-area" style="margin-bottom: 0;">
                    <label style="font-weight: 600; color: #333; margin-bottom: 10px; display: block;">éªŒè¯ç ï¼ˆè¯·åœ¨1åˆ†é’Ÿå†…éªŒè¯ï¼‰ï¼š</label>
                    <input type="text" id="verification-code" placeholder="è¯·è¾“å…¥4ä½éªŒè¯ç " maxlength="4" inputmode="numeric" pattern="[0-9]*" style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 22px; letter-spacing: 8px; text-align: center; font-weight: 600; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px;">
                        <button class="execute-btn" id="send-code-btn" onclick="sendVerificationCode()" style="flex: 1; padding: 14px; margin: 0; font-size: 16px;">å‘é€éªŒè¯ç </button>
                        <button class="execute-btn" id="verify-code-btn" onclick="verifyCode()" style="flex: 1; padding: 14px; margin: 0; background: #4caf50; font-size: 16px;">éªŒè¯</button>
                    </div>
                    <div id="verification-status" style="margin-top: 10px; padding: 12px; border-radius: 8px; display: none; font-size: 14px;"></div>
                </div>
            </div>
        </div>

        <!-- ç‰©å“ç”ŸæˆåŒºåŸŸ -->
        <div id="items-section" class="section active">
            <div class="sub-menu">
                <button class="sub-btn active" onclick="showItemType('item')">ç‰©å“</button>
                <button class="sub-btn" onclick="showItemType('weapon')">æ­¦å™¨</button>
                <button class="sub-btn" onclick="showItemType('avatar')">è§’è‰²</button>
                <button class="sub-btn" onclick="showItemType('artifact')">åœ£é—ç‰©</button>
            </div>

            <div class="form-group" id="item-select-group">
                <label id="item-label">é€‰æ‹©ç‰©å“ï¼š</label>
                <div class="select-input" id="item-select-input" onclick="openItemPanel()">
                    <span class="placeholder" id="item-display">ç‚¹å‡»é€‰æ‹©ç‰©å“...</span>
                    <span class="arrow">â–¼</span>
                </div>
            </div>

            <!-- ç‰©å“æ•°é‡è¾“å…¥æ¡†ï¼ˆä»…ç‰©å“ç±»å‹æ˜¾ç¤ºï¼‰ -->
            <div class="form-group" id="item-quantity-group">
                <label>æ•°é‡ï¼š</label>
                <input type="number" id="item-quantity" value="1" min="1" max="9999">
            </div>

            <!-- æ­¦å™¨ä¸“ç”¨è¾“å…¥æ¡† -->
            <div class="form-group" id="weapon-level-group" style="display: none;">
                <label>æ­¦å™¨ç­‰çº§ï¼š</label>
                <input type="number" id="weapon-level" value="90" min="1" max="101" placeholder="æœ€é«˜101çº§">
            </div>
            <div class="form-group" id="weapon-refinement-group" style="display: none;">
                <label>ç²¾ç‚¼ç­‰çº§ï¼š</label>
                <input type="number" id="weapon-refinement" value="1" min="1" max="5" placeholder="æœ€é«˜ç²¾ç‚¼5">
            </div>
            <div class="form-group" id="weapon-quantity-group" style="display: none;">
                <label>æ•°é‡ï¼š</label>
                <input type="number" id="weapon-quantity" value="1" min="1" max="99">
            </div>

            <!-- è§’è‰²ä¸“ç”¨è¾“å…¥æ¡† -->
            <div class="form-group" id="avatar-level-group" style="display: none;">
                <label>è§’è‰²ç­‰çº§ï¼š</label>
                <input type="number" id="avatar-level" value="90" min="1" max="90" placeholder="æœ€é«˜90çº§">
            </div>

            <!-- åœ£é—ç‰©ä¸“ç”¨é€‰æ‹©æ¡† -->
            <div class="form-group" id="artifact-build-group" style="display: none;">
                <label>é€‰æ‹©æ„å»ºå¥—è£…ï¼š</label>
                <select id="artifact-build-select" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    <option value="">è¯·é€‰æ‹©æ„å»ºå¥—è£…...</option>
                    <optgroup label="å…ƒç´ DPSå¥—è£…">
                        <option value="crimson">Crimson - ç«å¥—DPS</option>
                        <option value="pyrocodex">Pyrocodex - ç«ç³»æ³•å…¸</option>
                        <option value="pyroscroll">Pyroscroll - ç«ç³»å·è½´</option>
                        <option value="hydronymph">Hydronymph - æ°´å¥—</option>
                        <option value="anemodps1">AnemoDPS1 - é£å¥—DPS 1</option>
                        <option value="anemodps2">AnemoDPS2 - é£å¥—DPS 2</option>
                    </optgroup>
                    <optgroup label="è‰å…ƒç´ å¥—è£…">
                        <option value="dendroEM">DendroEM - è‰å…ƒç´ ç²¾é€š</option>
                        <option value="dendrosup1">DendroSup1 - è‰è¾…åŠ© 1</option>
                        <option value="dendrosup2">DendroSup2 - è‰è¾…åŠ© 2</option>
                    </optgroup>
                    <optgroup label="é€šç”¨å¥—è£…">
                        <option value="emblem1">Emblem1 - ç»ç¼˜å¥—è£… 1</option>
                        <option value="emblem2">Emblem2 - ç»ç¼˜å¥—è£… 2</option>
                        <option value="archaicdps">ArchaicDPS - å¤åDPS</option>
                        <option value="archaicdps2">ArchaicDPS2 - å¤åDPS 2</option>
                    </optgroup>
                    <optgroup label="å…ƒç´ ç²¾é€š">
                        <option value="em1">EM1 - å…ƒç´ ç²¾é€š 1</option>
                        <option value="em2">EM2 - å…ƒç´ ç²¾é€š 2</option>
                    </optgroup>
                </select>
            </div>

            <button class="generate-btn" onclick="generateGiveCommand()">ç”ŸæˆæŒ‡ä»¤</button>
            <button class="execute-btn" id="execute-item-btn" onclick="executeGeneratedCommand('items')" disabled>å‘æœåŠ¡å™¨æ‰§è¡ŒæŒ‡ä»¤</button>
        </div>

        <!-- ä»»åŠ¡åŒºåŸŸ -->
        <div id="quest-section" class="section">
            <div class="sub-menu">
                <button class="sub-btn active" onclick="showQuestType('add')">æ·»åŠ ä»»åŠ¡</button>
                <button class="sub-btn" onclick="showQuestType('finish')">å®Œæˆä»»åŠ¡</button>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©ä»»åŠ¡ï¼š</label>
                <div class="select-input" id="quest-select-input" onclick="openQuestPanel()">
                    <span class="placeholder" id="quest-display">ç‚¹å‡»é€‰æ‹©ä»»åŠ¡...</span>
                    <span class="arrow">â–¼</span>
                </div>
            </div>

            <button class="generate-btn" onclick="generateQuestCommand()">ç”ŸæˆæŒ‡ä»¤</button>
            <button class="execute-btn" id="execute-quest-btn" onclick="executeGeneratedCommand('quest')" disabled>å‘æœåŠ¡å™¨æ‰§è¡ŒæŒ‡ä»¤</button>
        </div>

        <!-- è‡ªå®šä¹‰æŒ‡ä»¤åŒºåŸŸ -->
        <div id="custom-section" class="section">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ”§ è‡ªå®šä¹‰æŒ‡ä»¤è¾“å…¥</h2>

            <div class="form-group">
                <label>è¾“å…¥æŒ‡ä»¤ï¼š</label>
                <textarea id="custom-command-input" rows="4" placeholder="ä¾‹å¦‚: give 201 x999&#10;æˆ–: tp 2000 300 -1000&#10;æˆ–: unlockall&#10;&#10;æ³¨æ„ï¼šä¸è¦åŒ…å«UIDï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ " style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-family: monospace; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="generate-btn" onclick="validateAndExecuteCustomCommand()">éªŒè¯å¹¶æ‰§è¡ŒæŒ‡ä»¤</button>
                <button class="generate-btn" style="background: #6c757d;" onclick="clearCustomCommand()">æ¸…ç©º</button>
            </div>

            <!-- æŒ‡ä»¤éªŒè¯ç»“æœæ˜¾ç¤º -->
            <div id="custom-command-result" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;"></div>

            <!-- å®‰å…¨æç¤º -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                <h3 style="margin: 0 0 10px 0; color: #f57c00; font-size: 16px;">âš ï¸ å®‰å…¨æç¤º</h3>
                <div style="font-size: 14px; color: #555; line-height: 1.6;">
                    <p style="margin: 5px 0;">ä¸ºäº†ç³»ç»Ÿå®‰å…¨ï¼Œä»¥ä¸‹ç±»å‹çš„æŒ‡ä»¤å°†è¢«<strong>è‡ªåŠ¨æ‹¦æˆª</strong>ï¼š</p>
                    <ul style="margin: 5px 0 10px 20px;">
                        <li>âŒ æƒé™ç®¡ç†æŒ‡ä»¤ (permission add/remove)</li>
                        <li>âŒ è´¦æˆ·ç®¡ç†æŒ‡ä»¤ (account create/delete)</li>
                        <li>âŒ æœåŠ¡å™¨æ§åˆ¶æŒ‡ä»¤ (stop, reload)</li>
                        <li>âŒ å°ç¦ç›¸å…³æŒ‡ä»¤ (ban, unban, kick)</li>
                    </ul>
                    <p style="margin: 5px 0; color: #4caf50;"><strong>âœ… å…è®¸çš„æŒ‡ä»¤ï¼š</strong>ä¼ é€ã€ç»™äºˆç‰©å“ã€è§’è‰²ç®¡ç†ã€åœºæ™¯æ§åˆ¶ç­‰ç©å®¶çº§æŒ‡ä»¤</p>
                </div>
            </div>
        </div>

        <!-- ç©å®¶æŒ‡ä»¤å¹¿åœºåŒºåŸŸ -->
        <div id="community-section" class="section">
            <div class="sub-menu">
                <button class="sub-btn active" onclick="showCommunityType('all')">æŒ‡ä»¤å¹¿åœº</button>
                <button class="sub-btn" onclick="showCommunityType('scene')">åœºæ™¯</button>
                <button class="sub-btn" onclick="showCommunityType('avatar')">è§’è‰²</button>
                <button class="sub-btn" onclick="showCommunityType('upload')">ä¸Šä¼ æŒ‡ä»¤</button>
            </div>

            <!-- æŒ‡ä»¤åˆ—è¡¨ -->
            <div id="community-list" class="community-list">
                <!-- åŠ¨æ€ç”ŸæˆæŒ‡ä»¤å¡ç‰‡ -->
            </div>

            <!-- ä¸Šä¼ æŒ‡ä»¤è¡¨å• -->
            <div id="upload-form" class="upload-form" style="display: none;">
                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 16px;">ğŸ“ æŒ‡ä»¤ä¸Šä¼ è¯´æ˜</h3>
                    <div style="font-size: 14px; color: #555; line-height: 1.6;">
                        <p style="margin: 5px 0;"><strong>UIDå ä½ç¬¦ï¼š</strong></p>
                        <ul style="margin: 5px 0 10px 20px;">
                            <li>å¯ä»¥ä½¿ç”¨ <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">@</code> æˆ– <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">@UID</code> ä½œä¸ºUIDå ä½ç¬¦</li>
                            <li>æˆ–è€…ç›´æ¥ä¸å†™UIDï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ ï¼ˆæ¨èï¼‰</li>
                        </ul>
                        <p style="margin: 5px 0;"><strong>ç¤ºä¾‹ï¼š</strong></p>
                        <ul style="margin: 5px 0 10px 20px;">
                            <li>âœ… <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">give 201 99</code> ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ UIDï¼‰</li>
                            <li>âœ… <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">give @ 201 99</code></li>
                            <li>âœ… <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">give @UID 201 99</code></li>
                            <li>âœ… <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">tp 2000 300 -1000</code></li>
                        </ul>
                        <p style="margin: 5px 0; color: #f44336;"><strong>âš ï¸ æ³¨æ„ï¼š</strong>ä¸è¦åŒ…å«åˆ†å·(;)ã€åŒä¸å·(&&)ç­‰ç‰¹æ®Šå­—ç¬¦</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>æŒ‡ä»¤æ ‡é¢˜ï¼š</label>
                    <input type="text" id="cmd-title" placeholder="è¯·è¾“å…¥æŒ‡ä»¤æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰">
                </div>

                <div class="form-group">
                    <label>æŒ‡ä»¤æè¿°ï¼š</label>
                    <textarea id="cmd-description" rows="3" placeholder="è¯·æè¿°è¿™ä¸ªæŒ‡ä»¤çš„ä½œç”¨ï¼ˆå¿…å¡«ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label>æŒ‡ä»¤å†…å®¹ï¼š</label>
                    <textarea id="cmd-command" rows="4" placeholder="ä¾‹å¦‚: give 201 99 æˆ– tp 2000 300 -1000ï¼ˆUIDä¼šè‡ªåŠ¨æ·»åŠ ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label>åˆ†ç±»ï¼š</label>
                    <select id="cmd-category">
                        <option value="item">ç‰©å“</option>
                        <option value="weapon">æ­¦å™¨</option>
                        <option value="avatar">è§’è‰²</option>
                        <option value="quest">ä»»åŠ¡</option>
                        <option value="scene">åœºæ™¯</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ è€…åç§°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="cmd-uploader" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°">
                </div>

                <button class="generate-btn" onclick="submitPlayerCommand()">æäº¤æŒ‡ä»¤</button>
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result-box" class="result-box">
            <div class="command-text" id="command-text"></div>
            <button class="copy-btn" onclick="copyCommand()">ğŸ“‹ å¤åˆ¶æŒ‡ä»¤</button>
        </div>
    </div>

    <!-- ç‰©å“é€‰æ‹©é¢æ¿ -->
    <div class="select-panel" id="item-panel" onclick="closeItemPanel(event)">
        <div class="select-panel-content" onclick="event.stopPropagation()">
            <div class="panel-search-header">
                <input type="text" id="item-panel-search" placeholder="ğŸ” æœç´¢ç‰©å“åç§°æˆ–ID..." oninput="filterPanelItems()">
            </div>
            <div class="panel-options" id="item-panel-options">
                <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
            </div>
            <div class="panel-footer">
                <button class="cancel-btn" onclick="closeItemPanel()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="confirmItemSelection()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡é€‰æ‹©é¢æ¿ -->
    <div class="select-panel" id="quest-panel" onclick="closeQuestPanel(event)">
        <div class="select-panel-content" onclick="event.stopPropagation()">
            <div class="panel-search-header">
                <input type="text" id="quest-panel-search" placeholder="ğŸ” æœç´¢ä»»åŠ¡åç§°æˆ–ID..." oninput="filterPanelQuests()">
            </div>
            <div class="panel-options" id="quest-panel-options">
                <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
            </div>
            <div class="panel-footer">
                <button class="cancel-btn" onclick="closeQuestPanel()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="confirmQuestSelection()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const API_BASE = '/api';
        let currentItemType = 'item';
        let currentQuestType = 'add';
        let gcConfig = null;
        let isServerConnected = false;
        let lastGeneratedCommand = '';

        // æ•°æ®ç¼“å­˜ - é¿å…é‡å¤åŠ è½½
        let cachedData = {
            items: null,
            weapons: null,
            avatars: null,
            quests: null
        };

        // å½“å‰æ˜¾ç¤ºçš„å®Œæ•´æ•°æ®
        let currentItemData = [];
        let currentQuestData = [];

        // é€‰ä¸­çš„é¡¹
        let selectedItemId = null;
        let selectedItemName = '';
        let selectedQuestId = null;
        let selectedQuestName = '';
        let tempSelectedItemId = null;
        let tempSelectedQuestId = null;

        // å®šæœŸæ£€æŸ¥éªŒè¯çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
        function startVerificationExpiryCheck() {
            setInterval(() => {
                const saved = localStorage.getItem('verification');
                if (saved) {
                    const data = JSON.parse(saved);
                    const expiryTime = new Date(data.expiryTime);
                    const now = new Date();

                    if (now >= expiryTime) {
                        // å·²è¿‡æœŸï¼Œæ¸…é™¤çŠ¶æ€
                        console.log('éªŒè¯å·²è¿‡æœŸï¼Œæ¸…é™¤çŠ¶æ€');
                        localStorage.removeItem('verification');
                        updateVerificationUI(false);
                    }
                }
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            checkAuthentication().then(authenticated => {
                if (!authenticated) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                    window.location.href = '/login.html';
                    return;
                }

                // å·²ç™»å½•ï¼Œç»§ç»­åˆå§‹åŒ–
                loadUserInfo();
                loadItemData('item');
                loadQuestData();
                loadGCConfig();
                autoConnectServer();
                loadPlayerUid(); // åŠ è½½ä¿å­˜çš„UID
                loadVerifiedUids(); // åŠ è½½ç”¨æˆ·çš„å·²éªŒè¯UIDåˆ—è¡¨
                startVerificationExpiryCheck(); // å¯åŠ¨éªŒè¯çŠ¶æ€è¿‡æœŸæ£€æŸ¥
            });
        };

        // ==================== ç”¨æˆ·è®¤è¯ç›¸å…³å‡½æ•° ====================

        /**
         * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
         */
        async function checkAuthentication() {
            const sessionToken = localStorage.getItem('sessionToken');

            if (!sessionToken) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/user-info?sessionToken=${encodeURIComponent(sessionToken)}`);
                const result = await response.json();

                if (result.success) {
                    // Sessionæœ‰æ•ˆï¼Œæ›´æ–°localStorageä¸­çš„ç”¨æˆ·æ•°æ®
                    localStorage.setItem('username', result.username);
                    localStorage.setItem('verifiedUids', JSON.stringify(result.verifiedUids || []));
                    return true;
                } else {
                    // Sessionæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
                    localStorage.removeItem('sessionToken');
                    localStorage.removeItem('username');
                    localStorage.removeItem('verifiedUids');
                    return false;
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                return false;
            }
        }

        /**
         * åŠ è½½å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
         */
        function loadUserInfo() {
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById('current-username').textContent = username;
            }
        }

        /**
         * ç™»å‡º
         */
        async function logout() {
            const sessionToken = localStorage.getItem('sessionToken');

            if (sessionToken) {
                try {
                    await fetch(`${API_BASE}/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sessionToken })
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            // æ¸…é™¤æœ¬åœ°æ•°æ®
            localStorage.removeItem('sessionToken');
            localStorage.removeItem('username');
            localStorage.removeItem('verifiedUids');
            localStorage.removeItem('verification');
            localStorage.removeItem('playerUid');

            // è·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = '/login.html';
        }

        /**
         * åŠ è½½ç”¨æˆ·çš„å·²éªŒè¯UIDåˆ—è¡¨
         */
        async function loadVerifiedUids() {
            const sessionToken = localStorage.getItem('sessionToken');
            if (!sessionToken) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/user-info?sessionToken=${encodeURIComponent(sessionToken)}`);
                const result = await response.json();

                if (result.success) {
                    const verifiedUids = result.verifiedUids || [];
                    localStorage.setItem('verifiedUids', JSON.stringify(verifiedUids));
                    displayVerifiedUids(verifiedUids);
                    updateUidSelect(verifiedUids);
                }
            } catch (error) {
                console.error('Failed to load verified UIDs:', error);
            }
        }

        /**
         * æ˜¾ç¤ºå·²éªŒè¯çš„UIDåˆ—è¡¨
         */
        function displayVerifiedUids(uids) {
            const container = document.getElementById('uids-container');

            if (!uids || uids.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 14px;">æš‚æ— å·²éªŒè¯çš„UID</div>';
                return;
            }

            container.innerHTML = uids.map(uid => `
                <div style="display: flex; align-items: center; gap: 8px; background: white; padding: 10px 15px; border-radius: 8px; border: 2px solid #667eea;">
                    <span style="font-weight: 600; color: #667eea; font-size: 16px;">${uid}</span>
                    <button onclick="removeUid('${uid}')" style="background: #ff4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
                </div>
            `).join('');
        }

        /**
         * æ›´æ–°UIDé€‰æ‹©ä¸‹æ‹‰æ¡†
         */
        function updateUidSelect(uids) {
            const select = document.getElementById('player-uid');
            const savedUid = localStorage.getItem('playerUid');

            select.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªUID</option>';

            uids.forEach(uid => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = uid;
                if (uid === savedUid) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        /**
         * ç§»é™¤å·²éªŒè¯çš„UID
         */
        async function removeUid(uid) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤UID ${uid} å—ï¼Ÿ`)) {
                return;
            }

            const sessionToken = localStorage.getItem('sessionToken');
            if (!sessionToken) {
                alert('æœªç™»å½•');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/remove-uid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionToken,
                        uid
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('UIDå·²ç§»é™¤');
                    loadVerifiedUids(); // é‡æ–°åŠ è½½åˆ—è¡¨

                    // å¦‚æœç§»é™¤çš„æ˜¯å½“å‰ä½¿ç”¨çš„UIDï¼Œæ¸…é™¤é€‰æ‹©
                    const currentUid = document.getElementById('player-uid').value;
                    if (currentUid === uid) {
                        document.getElementById('player-uid').value = '';
                        localStorage.removeItem('playerUid');
                    }
                } else {
                    alert(result.message || 'ç§»é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Remove UID error:', error);
                alert('ç§»é™¤å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æ£€æŸ¥UIDæ˜¯å¦å·²éªŒè¯ï¼ˆæ£€æŸ¥ç”¨æˆ·è´¦æˆ·ï¼‰
         */
        function isUidAlreadyVerified(uid) {
            const verifiedUids = JSON.parse(localStorage.getItem('verifiedUids') || '[]');
            return verifiedUids.includes(uid);
        }

        // æ˜¾ç¤ºä¸»åŠŸèƒ½åŒº
        function showSection(section) {
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');

            document.getElementById('result-box').classList.remove('show');

            // å¦‚æœåˆ‡æ¢åˆ°ç©å®¶æŒ‡ä»¤å¹¿åœºï¼Œè‡ªåŠ¨åŠ è½½æŒ‡ä»¤åˆ—è¡¨
            if (section === 'community') {
                showCommunityType('all'); // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰æŒ‡ä»¤
            }
        }

        // æ˜¾ç¤ºç‰©å“ç±»å‹ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½ï¼‰
        function showItemType(type) {
            currentItemType = type;

            document.querySelectorAll('#items-section .sub-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const labels = {item: 'ç‰©å“', weapon: 'æ­¦å™¨', avatar: 'è§’è‰²', artifact: 'åœ£é—ç‰©æ„å»º'};

            // åœ£é—ç‰©ç±»å‹ç‰¹æ®Šå¤„ç†ï¼šä¸éœ€è¦é€‰æ‹©ç‰©å“ï¼Œç›´æ¥é€‰æ‹©æ„å»º
            const itemSelectGroup = document.getElementById('item-select-group');
            if (type === 'artifact') {
                itemSelectGroup.style.display = 'none'; // éšè—ç‰©å“é€‰æ‹©æ¡†
            } else {
                itemSelectGroup.style.display = 'block';
                document.getElementById('item-label').textContent = 'é€‰æ‹©' + labels[type] + 'ï¼š';

                // æ¸…ç©ºé€‰æ‹©
                selectedItemId = null;
                selectedItemName = '';
                document.getElementById('item-display').textContent = 'ç‚¹å‡»é€‰æ‹©' + labels[type] + '...';
                document.getElementById('item-display').className = 'placeholder';
            }

            // æ ¹æ®ç±»å‹æ˜¾ç¤º/éšè—å¯¹åº”çš„è¾“å…¥æ¡†
            const itemQuantityGroup = document.getElementById('item-quantity-group');
            const weaponLevelGroup = document.getElementById('weapon-level-group');
            const weaponRefinementGroup = document.getElementById('weapon-refinement-group');
            const weaponQuantityGroup = document.getElementById('weapon-quantity-group');
            const avatarLevelGroup = document.getElementById('avatar-level-group');
            const artifactBuildGroup = document.getElementById('artifact-build-group');

            // å…ˆéšè—æ‰€æœ‰è¾“å…¥æ¡†
            itemQuantityGroup.style.display = 'none';
            weaponLevelGroup.style.display = 'none';
            weaponRefinementGroup.style.display = 'none';
            weaponQuantityGroup.style.display = 'none';
            avatarLevelGroup.style.display = 'none';
            artifactBuildGroup.style.display = 'none';

            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„è¾“å…¥æ¡†
            if (type === 'item') {
                itemQuantityGroup.style.display = 'block';
            } else if (type === 'weapon') {
                weaponLevelGroup.style.display = 'block';
                weaponRefinementGroup.style.display = 'block';
                weaponQuantityGroup.style.display = 'block';
            } else if (type === 'avatar') {
                avatarLevelGroup.style.display = 'block';
            } else if (type === 'artifact') {
                artifactBuildGroup.style.display = 'block';
            }

            // åªåœ¨ç¼“å­˜ä¸å­˜åœ¨æ—¶æ‰åŠ è½½æ•°æ®ï¼ˆåœ£é—ç‰©ä¸éœ€è¦åŠ è½½æ•°æ®ï¼‰
            if (type !== 'artifact') {
                if (!cachedData[type + 's']) {
                    loadItemData(type);
                } else {
                    // ä½¿ç”¨ç¼“å­˜æ•°æ®
                    currentItemData = cachedData[type + 's'];
                }
            }

            document.getElementById('result-box').classList.remove('show');
        }

        // æ˜¾ç¤ºä»»åŠ¡ç±»å‹
        function showQuestType(type) {
            currentQuestType = type;
            
            document.querySelectorAll('#quest-section .sub-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('result-box').classList.remove('show');
        }

        // åŠ è½½ç‰©å“æ•°æ®ï¼ˆä¼˜åŒ–ï¼šç¼“å­˜æ•°æ®ï¼‰
        async function loadItemData(type) {
            const endpoints = {item: 'items', weapon: 'weapons', avatar: 'avatars'};
            const cacheKey = type + 's';

            try {
                const response = await fetch(`${API_BASE}/${endpoints[type]}`);
                const data = await response.json();

                // ç¼“å­˜æ•°æ®
                cachedData[cacheKey] = data;
                currentItemData = data;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ‰“å¼€ç‰©å“é€‰æ‹©é¢æ¿
        function openItemPanel() {
            // å¦‚æœæ•°æ®è¿˜æœªåŠ è½½ï¼Œæç¤ºç”¨æˆ·
            if (!currentItemData || currentItemData.length === 0) {
                alert('æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // æ¸²æŸ“é¢æ¿é€‰é¡¹
            renderPanelItems(currentItemData);

            // æ˜¾ç¤ºé¢æ¿
            document.getElementById('item-panel').classList.add('active');
            document.getElementById('item-select-input').classList.add('active');

            // èšç„¦æœç´¢æ¡†
            setTimeout(() => {
                document.getElementById('item-panel-search').focus();
            }, 100);

            // è®¾ç½®ä¸´æ—¶é€‰ä¸­é¡¹
            tempSelectedItemId = selectedItemId;
        }

        // æ¸²æŸ“é¢æ¿ç‰©å“é€‰é¡¹
        function renderPanelItems(data) {
            const container = document.getElementById('item-panel-options');
            container.innerHTML = '';

            data.forEach(item => {
                const option = document.createElement('div');
                option.className = 'panel-option';
                if (item.id === selectedItemId) {
                    option.classList.add('selected');
                }
                option.textContent = `${item.name} (${item.id})`;
                option.dataset.id = item.id;
                option.dataset.name = item.name.toLowerCase();
                option.onclick = () => selectPanelItem(item.id, option);
                container.appendChild(option);
            });
        }

        // é€‰æ‹©é¢æ¿ä¸­çš„é¡¹
        function selectPanelItem(itemId, optionElement) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#item-panel-options .panel-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            optionElement.classList.add('selected');
            tempSelectedItemId = itemId;
        }

        // ç¡®è®¤ç‰©å“é€‰æ‹©
        function confirmItemSelection() {
            if (!tempSelectedItemId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç‰©å“ï¼');
                return;
            }

            selectedItemId = tempSelectedItemId;

            // æŸ¥æ‰¾é€‰ä¸­çš„ç‰©å“ä¿¡æ¯
            const item = currentItemData.find(i => i.id === selectedItemId);
            if (item) {
                selectedItemName = item.name;
                const displayElement = document.getElementById('item-display');
                displayElement.textContent = `${item.name} (${item.id})`;
                displayElement.className = 'value';
            }

            closeItemPanel();
        }

        // å…³é—­ç‰©å“é¢æ¿
        function closeItemPanel(event) {
            if (event && event.target.id !== 'item-panel') return;

            document.getElementById('item-panel').classList.remove('active');
            document.getElementById('item-select-input').classList.remove('active');
            document.getElementById('item-panel-search').value = '';

            // é‡æ–°æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
            document.querySelectorAll('#item-panel-options .panel-option').forEach(opt => {
                opt.classList.remove('hidden');
            });
        }

        // è¿‡æ»¤é¢æ¿ç‰©å“
        function filterPanelItems() {
            const searchText = document.getElementById('item-panel-search').value.toLowerCase();
            const options = document.querySelectorAll('#item-panel-options .panel-option');

            options.forEach(option => {
                const name = option.dataset.name || '';
                const id = option.dataset.id || '';

                if (name.includes(searchText) || id.includes(searchText)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }

        // åŠ è½½ä»»åŠ¡æ•°æ®ï¼ˆä¼˜åŒ–ï¼šç¼“å­˜æ•°æ®ï¼‰
        async function loadQuestData() {
            // å¦‚æœå·²ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨
            if (cachedData.quests) {
                currentQuestData = cachedData.quests;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/quests`);
                const data = await response.json();

                // ç¼“å­˜æ•°æ®
                cachedData.quests = data;
                currentQuestData = data;
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // æ‰“å¼€ä»»åŠ¡é€‰æ‹©é¢æ¿
        function openQuestPanel() {
            // å¦‚æœæ•°æ®è¿˜æœªåŠ è½½ï¼Œæç¤ºç”¨æˆ·
            if (!currentQuestData || currentQuestData.length === 0) {
                alert('æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            // æ¸²æŸ“é¢æ¿é€‰é¡¹
            renderPanelQuests(currentQuestData);

            // æ˜¾ç¤ºé¢æ¿
            document.getElementById('quest-panel').classList.add('active');
            document.getElementById('quest-select-input').classList.add('active');

            // èšç„¦æœç´¢æ¡†
            setTimeout(() => {
                document.getElementById('quest-panel-search').focus();
            }, 100);

            // è®¾ç½®ä¸´æ—¶é€‰ä¸­é¡¹
            tempSelectedQuestId = selectedQuestId;
        }

        // æ¸²æŸ“é¢æ¿ä»»åŠ¡é€‰é¡¹
        function renderPanelQuests(data) {
            const container = document.getElementById('quest-panel-options');
            container.innerHTML = '';

            data.forEach(quest => {
                const option = document.createElement('div');
                option.className = 'panel-option';
                if (quest.id === selectedQuestId) {
                    option.classList.add('selected');
                }
                option.textContent = `${quest.name} (${quest.id})`;
                option.dataset.id = quest.id;
                option.dataset.name = quest.name.toLowerCase();
                option.onclick = () => selectPanelQuest(quest.id, option);
                container.appendChild(option);
            });
        }

        // é€‰æ‹©é¢æ¿ä¸­çš„ä»»åŠ¡
        function selectPanelQuest(questId, optionElement) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#quest-panel-options .panel-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            optionElement.classList.add('selected');
            tempSelectedQuestId = questId;
        }

        // ç¡®è®¤ä»»åŠ¡é€‰æ‹©
        function confirmQuestSelection() {
            if (!tempSelectedQuestId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡ï¼');
                return;
            }

            selectedQuestId = tempSelectedQuestId;

            // æŸ¥æ‰¾é€‰ä¸­çš„ä»»åŠ¡ä¿¡æ¯
            const quest = currentQuestData.find(q => q.id === selectedQuestId);
            if (quest) {
                selectedQuestName = quest.name;
                const displayElement = document.getElementById('quest-display');
                displayElement.textContent = `${quest.name} (${quest.id})`;
                displayElement.className = 'value';
            }

            closeQuestPanel();
        }

        // å…³é—­ä»»åŠ¡é¢æ¿
        function closeQuestPanel(event) {
            if (event && event.target.id !== 'quest-panel') return;

            document.getElementById('quest-panel').classList.remove('active');
            document.getElementById('quest-select-input').classList.remove('active');
            document.getElementById('quest-panel-search').value = '';

            // é‡æ–°æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
            document.querySelectorAll('#quest-panel-options .panel-option').forEach(opt => {
                opt.classList.remove('hidden');
            });
        }

        // è¿‡æ»¤é¢æ¿ä»»åŠ¡
        function filterPanelQuests() {
            const searchText = document.getElementById('quest-panel-search').value.toLowerCase();
            const options = document.querySelectorAll('#quest-panel-options .panel-option');

            options.forEach(option => {
                const name = option.dataset.name || '';
                const id = option.dataset.id || '';

                if (name.includes(searchText) || id.includes(searchText)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }

        // ç”Ÿæˆç‰©å“æŒ‡ä»¤
        async function generateGiveCommand() {
            const globalUid = document.getElementById('player-uid').value.trim();
            let command = '';

            // åœ£é—ç‰©ç±»å‹ç‰¹æ®Šå¤„ç†
            if (currentItemType === 'artifact') {
                const buildName = document.getElementById('artifact-build-select').value;
                if (!buildName) {
                    alert('è¯·é€‰æ‹©åœ£é—ç‰©æ„å»ºå¥—è£…ï¼');
                    return;
                }
                // build å‘½ä»¤æ ¼å¼ï¼šbuild æ„å»ºåç§° @UID
                command = `build ${buildName}`;
            } else {
                // å…¶ä»–ç±»å‹éœ€è¦é€‰æ‹©ç‰©å“
                const itemId = selectedItemId;
                if (!itemId) {
                    const labels = {item: 'ç‰©å“', weapon: 'æ­¦å™¨', avatar: 'è§’è‰²'};
                    alert('è¯·é€‰æ‹©' + labels[currentItemType] + 'ï¼');
                    return;
                }

                // æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒæ ¼å¼çš„å‘½ä»¤
                if (currentItemType === 'item') {
                    // ç‰©å“ï¼šgive ç‰©å“ID xæ•°é‡
                    const quantity = parseInt(document.getElementById('item-quantity').value);
                    if (!quantity || quantity <= 0) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡ï¼');
                        return;
                    }
                    command = `give ${itemId} x${quantity}`;
                } else if (currentItemType === 'weapon') {
                    // æ­¦å™¨ï¼šgive æ­¦å™¨ID lvç­‰çº§ xæ•°é‡ rç²¾ç‚¼ç­‰çº§
                    const level = parseInt(document.getElementById('weapon-level').value);
                    const refinement = parseInt(document.getElementById('weapon-refinement').value);
                    const quantity = parseInt(document.getElementById('weapon-quantity').value);

                    if (!level || level <= 0 || level > 101) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­¦å™¨ç­‰çº§ï¼ˆ1-101ï¼‰ï¼');
                        return;
                    }
                    if (!refinement || refinement <= 0 || refinement > 5) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç²¾ç‚¼ç­‰çº§ï¼ˆ1-5ï¼‰ï¼');
                        return;
                    }
                    if (!quantity || quantity <= 0) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡ï¼');
                        return;
                    }

                    command = `give ${itemId} lv${level} x${quantity} r${refinement}`;
                } else if (currentItemType === 'avatar') {
                    // è§’è‰²ï¼šgive è§’è‰²ID lvç­‰çº§
                    const level = parseInt(document.getElementById('avatar-level').value);
                    if (!level || level <= 0 || level > 90) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è§’è‰²ç­‰çº§ï¼ˆ1-90ï¼‰ï¼');
                        return;
                    }
                    command = `give ${itemId} lv${level}`;
                }
            }

            // æ·»åŠ UIDå ä½ç¬¦ï¼ˆåç«¯ä¼šè‡ªåŠ¨å¤„ç†ä½ç½®ï¼‰
            if (globalUid) {
                command += ' @' + globalUid;
            } else {
                command += ' @';
            }

            showResult(command);
            lastGeneratedCommand = command;

            // å¦‚æœæœåŠ¡å™¨å·²è¿æ¥ï¼Œå¯ç”¨æ‰§è¡ŒæŒ‰é’®
            document.getElementById('execute-item-btn').disabled = !isServerConnected;
        }

        // ç”Ÿæˆä»»åŠ¡æŒ‡ä»¤
        async function generateQuestCommand() {
            const questId = selectedQuestId;
            const globalUid = document.getElementById('player-uid').value.trim();

            if (!questId) {
                alert('è¯·é€‰æ‹©ä»»åŠ¡ï¼');
                return;
            }

            const endpoint = currentQuestType === 'add' ? 'quest/add' : 'quest/finish';

            try {
                const response = await fetch(`${API_BASE}/command/${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({questId})
                });

                const result = await response.json();
                let command = result.command;

                // ä½¿ç”¨å…¨å±€UID
                if (globalUid) {
                    command += ' @' + globalUid;
                } else {
                    command += ' @';
                }

                showResult(command);
                lastGeneratedCommand = command;

                // å¦‚æœæœåŠ¡å™¨å·²è¿æ¥ï¼Œå¯ç”¨æ‰§è¡ŒæŒ‰é’®
                document.getElementById('execute-quest-btn').disabled = !isServerConnected;
            } catch (error) {
                alert('ç”ŸæˆæŒ‡ä»¤å¤±è´¥ï¼');
                console.error(error);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(command) {
            document.getElementById('command-text').textContent = command;
            document.getElementById('result-box').classList.add('show');
        }

        // å¤åˆ¶æŒ‡ä»¤
        function copyCommand() {
            const command = document.getElementById('command-text').textContent;
            navigator.clipboard.writeText(command).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // ========== Grasscutter æœåŠ¡å™¨è¿æ¥åŠŸèƒ½ ==========

        // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸï¼ˆå…¼å®¹ Grasscutter çš„ retcode=0 å’Œæ ‡å‡†çš„ retcode=200ï¼‰
        function isSuccess(result) {
            return result && (result.retcode === 0 || result.retcode === 200);
        }

        // åŠ è½½Grasscutteré…ç½®
        async function loadGCConfig() {
            try {
                const response = await fetch('/api/grasscutter/config');
                gcConfig = await response.json();

                // å¦‚æœæœ‰é…ç½®Tokenï¼Œè‡ªåŠ¨å¡«å……
                if (gcConfig.hasConsoleToken) {
                    console.log('å·²ä»é…ç½®åŠ è½½æ§åˆ¶å°Token');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // è‡ªåŠ¨è¿æ¥æœåŠ¡å™¨
        async function autoConnectServer() {
            // ç­‰å¾…é…ç½®åŠ è½½å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 500));

            if (!gcConfig) {
                console.log('é…ç½®æœªåŠ è½½ï¼Œè·³è¿‡è‡ªåŠ¨è¿æ¥');
                return;
            }

            try {
                const response = await fetch('/api/grasscutter/ping', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({serverUrl: gcConfig.fullUrl})
                });

                const result = await response.json();

                if (isSuccess(result)) {
                    isServerConnected = true;
                    // è·å–åœ¨çº¿ç©å®¶æ•°
                    getOnlinePlayerCount(gcConfig.fullUrl);
                } else {
                    updateServerStatus(false, 0);
                }
            } catch (error) {
                console.error('è‡ªåŠ¨è¿æ¥å¤±è´¥:', error);
                updateServerStatus(false, 0);
            }
        }

        // è·å–åœ¨çº¿ç©å®¶æ•°é‡
        async function getOnlinePlayerCount(serverUrl) {
            try {
                const response = await fetch('/api/grasscutter/online', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({serverUrl})
                });

                const result = await response.json();

                if (isSuccess(result) && result.data) {
                    const count = result.data.count || 0;
                    updateServerStatus(true, count);
                }
            } catch (error) {
                console.error('è·å–åœ¨çº¿ç©å®¶å¤±è´¥:', error);
                updateServerStatus(true, 0);
            }
        }

        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateServerStatus(connected, onlineCount) {
            const statusElement = document.getElementById('server-status');
            const countElement = document.getElementById('online-count');

            if (connected) {
                statusElement.textContent = 'å·²è¿æ¥';
                statusElement.className = 'status-value status-connected';
            } else {
                statusElement.textContent = 'æœªè¿æ¥';
                statusElement.className = 'status-value status-disconnected';
            }

            countElement.textContent = onlineCount + 'äºº';
        }

        // æ‰§è¡Œç”Ÿæˆçš„æŒ‡ä»¤
        async function executeGeneratedCommand(type) {
            if (!lastGeneratedCommand) {
                alert('è¯·å…ˆç”ŸæˆæŒ‡ä»¤ï¼');
                return;
            }

            if (!isServerConnected) {
                alert('æœåŠ¡å™¨æœªè¿æ¥ï¼');
                return;
            }

            if (!gcConfig || !gcConfig.hasConsoleToken) {
                alert('è¯·åœ¨config.jsonä¸­é…ç½®consoleTokenï¼');
                return;
            }

            const btn = type === 'items' ? document.getElementById('execute-item-btn') : document.getElementById('execute-quest-btn');
            btn.disabled = true;
            btn.textContent = 'æ‰§è¡Œä¸­...';

            try {
                const response = await fetch('/api/grasscutter/console', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        serverUrl: gcConfig.fullUrl,
                        command: lastGeneratedCommand
                    })
                });

                const result = await response.json();

                if (isSuccess(result)) {
                    alert('âœ… æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸï¼\n\n' + (result.data || 'æ— è¿”å›ä¿¡æ¯'));
                } else {
                    alert('âŒ æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ‰§è¡Œå¤±è´¥: ' + error.message);
                console.error('æ‰§è¡ŒæŒ‡ä»¤å¤±è´¥:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'å‘æœåŠ¡å™¨æ‰§è¡ŒæŒ‡ä»¤';
            }
        }

        // ========== è‡ªå®šä¹‰æŒ‡ä»¤åŠŸèƒ½ ==========

        // æ¸…ç©ºè‡ªå®šä¹‰æŒ‡ä»¤è¾“å…¥
        function clearCustomCommand() {
            document.getElementById('custom-command-input').value = '';
            const resultDiv = document.getElementById('custom-command-result');
            resultDiv.style.display = 'none';
        }

        // éªŒè¯å¹¶æ‰§è¡Œè‡ªå®šä¹‰æŒ‡ä»¤
        async function validateAndExecuteCustomCommand() {
            const command = document.getElementById('custom-command-input').value.trim();
            const resultDiv = document.getElementById('custom-command-result');
            const uid = document.getElementById('player-uid').value.trim();

            if (!command) {
                alert('è¯·è¾“å…¥æŒ‡ä»¤ï¼');
                return;
            }

            if (!uid) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªUIDï¼');
                return;
            }

            // æ£€æŸ¥UIDæ˜¯å¦å·²æ°¸ä¹…éªŒè¯ï¼ˆåœ¨ç”¨æˆ·è´¦æˆ·ä¸­ï¼‰
            const verifiedUids = JSON.parse(localStorage.getItem('verifiedUids') || '[]');
            if (!verifiedUids.includes(uid)) {
                // UIDæœªéªŒè¯
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.color = '#f57c00';
                resultDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">âš ï¸ éœ€è¦éªŒè¯UID</div>
                    <div style="font-size: 14px;">æ­¤UIDæœªç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·</div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        è¯·åœ¨é¡µé¢é¡¶éƒ¨"æ·»åŠ æ–°UID"åŒºåŸŸï¼š<br>
                        1. è¾“å…¥UIDå¹¶å‘é€éªŒè¯ç <br>
                        2. åœ¨æ¸¸æˆå¥½å‹æ¶ˆæ¯ä¸­æŸ¥çœ‹4ä½éªŒè¯ç <br>
                        3. éªŒè¯åUIDå°†æ°¸ä¹…ç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·
                    </div>
                `;
                return;
            }

            // UIDå·²éªŒè¯ï¼Œç›´æ¥æ‰§è¡Œ
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e3f2fd';
            resultDiv.style.color = '#1976d2';
            resultDiv.innerHTML = 'â³ æ‰§è¡Œä¸­...';

            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const response = await fetch('/api/commands/custom/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({command, uid, sessionToken})
                });

                const result = await response.json();

                if (result.success) {
                    // æˆåŠŸ
                    resultDiv.style.background = '#e8f5e9';
                    resultDiv.style.color = '#2e7d32';
                    resultDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">âœ… æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸ</div>
                        <div style="font-size: 14px; color: #666;">${result.data || 'æŒ‡ä»¤å·²æˆåŠŸå‘é€åˆ°æœåŠ¡å™¨'}</div>
                    `;
                } else if (result.dangerous) {
                    // å±é™©æŒ‡ä»¤è¢«æ‹¦æˆª
                    resultDiv.style.background = '#ffebee';
                    resultDiv.style.color = '#c62828';
                    resultDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">ğŸš« å±é™©æŒ‡ä»¤å·²æ‹¦æˆª</div>
                        <div style="font-size: 14px;">${result.message}</div>
                    `;
                } else if (result.needVerification) {
                    // éœ€è¦éªŒè¯
                    resultDiv.style.background = '#fff3cd';
                    resultDiv.style.color = '#f57c00';
                    resultDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">âš ï¸ éœ€è¦éªŒè¯UID</div>
                        <div style="font-size: 14px;">${result.message}</div>
                        <div style="margin-top: 10px; font-size: 13px;">è¯·åœ¨é¡µé¢é¡¶éƒ¨å®ŒæˆUIDéªŒè¯åå†æ‰§è¡ŒæŒ‡ä»¤</div>
                    `;
                } else {
                    // å…¶ä»–é”™è¯¯
                    resultDiv.style.background = '#ffebee';
                    resultDiv.style.color = '#c62828';
                    resultDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">âŒ æ‰§è¡Œå¤±è´¥</div>
                        <div style="font-size: 14px;">${result.message}</div>
                    `;
                }

            } catch (error) {
                resultDiv.style.background = '#ffebee';
                resultDiv.style.color = '#c62828';
                resultDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">âŒ ç½‘ç»œé”™è¯¯</div>
                    <div style="font-size: 14px;">${error.message}</div>
                `;
                console.error('æ‰§è¡Œè‡ªå®šä¹‰æŒ‡ä»¤å¤±è´¥:', error);
            }
        }

        // ========== ç©å®¶æŒ‡ä»¤å¹¿åœºåŠŸèƒ½ ==========
        let currentCommunityType = 'latest';

        // æ˜¾ç¤ºæŒ‡ä»¤å¹¿åœºç±»å‹
        function showCommunityType(type) {
            currentCommunityType = type;

            // æ›´æ–°å­èœå•æŒ‰é’®æ ·å¼
            const buttons = document.querySelectorAll('#community-section .sub-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
            const listDiv = document.getElementById('community-list');
            const formDiv = document.getElementById('upload-form');

            if (type === 'upload') {
                listDiv.style.display = 'none';
                formDiv.style.display = 'block';
            } else {
                listDiv.style.display = 'grid';
                formDiv.style.display = 'none';
                loadCommunityCommands(type);
            }
        }

        // åŠ è½½ç©å®¶æŒ‡ä»¤
        async function loadCommunityCommands(type) {
            const listDiv = document.getElementById('community-list');
            listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><div>åŠ è½½ä¸­...</div></div>';

            try {
                let url = '/api/commands/approved?sort=time';

                // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„å‚æ•°
                if (type === 'scene') {
                    url = '/api/commands/approved?category=scene&sort=time';
                } else if (type === 'avatar') {
                    url = '/api/commands/approved?category=avatar&sort=time';
                } else if (type === 'all') {
                    // æŒ‡ä»¤å¹¿åœºæ˜¾ç¤º"å…¶ä»–"åˆ†ç±»çš„æŒ‡ä»¤
                    url = '/api/commands/approved?category=other&sort=time';
                }

                const response = await fetch(url);
                const commands = await response.json();

                if (commands.length === 0) {
                    listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div>æš‚æ— æŒ‡ä»¤</div></div>';
                    return;
                }

                listDiv.innerHTML = commands.map(cmd => createCommandCard(cmd)).join('');
            } catch (error) {
                console.error('åŠ è½½æŒ‡ä»¤å¤±è´¥:', error);
                listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>';
            }
        }

        // åˆ›å»ºæŒ‡ä»¤å¡ç‰‡
        function createCommandCard(cmd) {
            const categoryNames = {
                'item': 'ç‰©å“',
                'weapon': 'æ­¦å™¨',
                'avatar': 'è§’è‰²',
                'quest': 'ä»»åŠ¡',
                'scene': 'åœºæ™¯',
                'other': 'å…¶ä»–'
            };

            const categoryName = categoryNames[cmd.category] || cmd.category;
            const uploaderName = cmd.uploaderName || 'åŒ¿å';

            return `
                <div class="command-card">
                    <div class="command-card-header">
                        <div class="command-card-title">${escapeHtml(cmd.title)}</div>
                        <div class="command-card-category">${categoryName}</div>
                    </div>
                    <div class="command-card-description">${escapeHtml(cmd.description)}</div>
                    <div class="command-card-content">${escapeHtml(cmd.command)}</div>
                    <div class="command-card-footer">
                        <div class="command-card-info">
                            <span>ğŸ‘¤ ${escapeHtml(uploaderName)}</span>
                            <span>ğŸ‘ ${cmd.views}</span>
                            <span>â¤ï¸ ${cmd.likes}</span>
                        </div>
                        <div class="command-card-actions">
                            <button class="like-btn" onclick="likePlayerCommand('${cmd.id}')">ç‚¹èµ</button>
                            <button class="use-btn" onclick="usePlayerCommand('${cmd.id}', '${escapeHtml(cmd.command)}')">ä½¿ç”¨</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æäº¤ç©å®¶æŒ‡ä»¤
        async function submitPlayerCommand() {
            const title = document.getElementById('cmd-title').value.trim();
            const description = document.getElementById('cmd-description').value.trim();
            const command = document.getElementById('cmd-command').value.trim();
            const category = document.getElementById('cmd-category').value;
            const uploaderName = document.getElementById('cmd-uploader').value.trim();

            if (!title) {
                alert('è¯·è¾“å…¥æŒ‡ä»¤æ ‡é¢˜ï¼');
                return;
            }

            if (!description) {
                alert('è¯·è¾“å…¥æŒ‡ä»¤æè¿°ï¼');
                return;
            }

            if (!command) {
                alert('è¯·è¾“å…¥æŒ‡ä»¤å†…å®¹ï¼');
                return;
            }

            try {
                const response = await fetch('/api/commands/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        command,
                        category,
                        uploaderName: uploaderName || 'åŒ¿å'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… æŒ‡ä»¤æäº¤æˆåŠŸï¼\n\næ‚¨çš„æŒ‡ä»¤å·²æäº¤å®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡åå°†åœ¨æŒ‡ä»¤å¹¿åœºæ˜¾ç¤ºã€‚');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('cmd-title').value = '';
                    document.getElementById('cmd-description').value = '';
                    document.getElementById('cmd-command').value = '';
                    document.getElementById('cmd-uploader').value = '';
                } else {
                    alert('âŒ æäº¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æäº¤å¤±è´¥: ' + error.message);
                console.error('æäº¤æŒ‡ä»¤å¤±è´¥:', error);
            }
        }

        // ========== UIDç®¡ç† ==========
        // åŠ è½½ä¿å­˜çš„UID
        function loadPlayerUid() {
            const savedUid = localStorage.getItem('playerUid');
            if (savedUid) {
                document.getElementById('player-uid').value = savedUid;
                // æ£€æŸ¥éªŒè¯çŠ¶æ€
                setTimeout(() => {
                    checkVerificationStatus();
                }, 500);
            }
        }

        // ä¿å­˜UIDåˆ°localStorage
        function savePlayerUid() {
            const uid = document.getElementById('player-uid').value.trim();
            if (uid) {
                localStorage.setItem('playerUid', uid);
                // æ£€æŸ¥è¿™ä¸ªUIDæ˜¯å¦å·²éªŒè¯ï¼Œå¹¶æ›´æ–°UI
                checkVerificationStatus();
            }
        }

        // è·å–å½“å‰UID
        function getPlayerUid() {
            const uid = document.getElementById('player-uid').value.trim();
            if (!uid) {
                // ä¸å¼¹çª—ï¼Œåªè¿”å›nullï¼Œè®©è°ƒç”¨è€…å†³å®šå¦‚ä½•å¤„ç†
                return null;
            }
            return uid;
        }

        // å‘é€éªŒè¯ç 
        async function sendVerificationCode() {
            // ä½¿ç”¨æ–°UIDè¾“å…¥æ¡†
            const uid = document.getElementById('new-uid-input').value.trim();

            if (!uid) {
                alert('è¯·å…ˆè¾“å…¥è¦æ·»åŠ çš„UIDï¼');
                return;
            }

            // æ£€æŸ¥UIDæ˜¯å¦å·²ç»éªŒè¯è¿‡
            if (isUidAlreadyVerified(uid)) {
                alert('è¯¥UIDå·²ç»éªŒè¯è¿‡äº†ï¼Œæ— éœ€é‡å¤éªŒè¯ï¼');
                return;
            }

            const sendBtn = document.getElementById('send-code-btn');
            const statusDiv = document.getElementById('verification-status');

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';

            try {
                const response = await fetch('/api/verification/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#e8f5e9';
                    statusDiv.style.color = '#2e7d32';
                    statusDiv.textContent = 'âœ… ' + result.message;

                    // å¼€å§‹å€’è®¡æ—¶ï¼ˆ60ç§’ï¼‰
                    let countdown = 60;
                    const countdownInterval = setInterval(() => {
                        sendBtn.textContent = `${countdown}ç§’åé‡è¯•`;
                        countdown--;
                        if (countdown < 0) {
                            clearInterval(countdownInterval);
                            sendBtn.disabled = false;
                            sendBtn.textContent = 'å‘é€éªŒè¯ç ';
                        }
                    }, 1000);
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = 'âŒ ' + result.message;
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'å‘é€éªŒè¯ç ';
                }
            } catch (error) {
                console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.textContent = 'âŒ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•';
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€éªŒè¯ç ';
            }
        }

        // éªŒè¯éªŒè¯ç 
        async function verifyCode() {
            // ä½¿ç”¨æ–°UIDè¾“å…¥æ¡†
            const uid = document.getElementById('new-uid-input').value.trim();

            if (!uid) {
                alert('è¯·å…ˆè¾“å…¥è¦æ·»åŠ çš„UIDï¼');
                return;
            }

            const code = document.getElementById('verification-code').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥4ä½éªŒè¯ç ï¼');
                return;
            }

            if (code.length !== 4 || !/^\d+$/.test(code)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„4ä½æ•°å­—éªŒè¯ç ï¼');
                return;
            }

            const verifyBtn = document.getElementById('verify-code-btn');
            const statusDiv = document.getElementById('verification-status');
            const sessionToken = localStorage.getItem('sessionToken');

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'éªŒè¯ä¸­...';

            try {
                // Step 1: éªŒè¯éªŒè¯ç 
                const verifyResponse = await fetch('/api/verification/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid, code })
                });

                const verifyResult = await verifyResponse.json();

                if (verifyResult.success) {
                    // Step 2: éªŒè¯æˆåŠŸåï¼Œä¿å­˜UIDåˆ°ç”¨æˆ·è´¦æˆ·
                    const addUidResponse = await fetch('/api/auth/add-uid', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionToken, uid })
                    });

                    const addUidResult = await addUidResponse.json();

                    if (addUidResult.success) {
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = '#e8f5e9';
                        statusDiv.style.color = '#2e7d32';
                        statusDiv.textContent = 'âœ… éªŒè¯æˆåŠŸï¼UIDå·²ç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·';

                        // ä¿å­˜éªŒè¯çŠ¶æ€åˆ°localStorageï¼ˆå‰ç«¯5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
                        const now = new Date();
                        const expiryTime = new Date(now.getTime() + 5 * 60 * 1000); // 5åˆ†é’Ÿåè¿‡æœŸ
                        const verificationData = {
                            uid: uid,
                            verified: true,
                            verifiedAt: now.toISOString(),
                            expiryTime: expiryTime.toISOString()
                        };
                        localStorage.setItem('verification', JSON.stringify(verificationData));

                        // é‡æ–°åŠ è½½å·²éªŒè¯UIDåˆ—è¡¨
                        await loadVerifiedUids();

                        // æ¸…ç©ºè¾“å…¥æ¡†
                        document.getElementById('verification-code').value = '';
                        document.getElementById('new-uid-input').value = '';

                        // æ›´æ–°UIçŠ¶æ€
                        updateVerificationUI(true);

                        // è‡ªåŠ¨é€‰æ‹©æ–°æ·»åŠ çš„UID
                        document.getElementById('player-uid').value = uid;
                        savePlayerUid();
                    } else {
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = '#ffebee';
                        statusDiv.style.color = '#c62828';
                        statusDiv.textContent = 'âŒ ç»‘å®šå¤±è´¥: ' + addUidResult.message;
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = 'éªŒè¯';
                    }
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ffebee';
                    statusDiv.style.color = '#c62828';
                    statusDiv.textContent = 'âŒ ' + verifyResult.message;
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'éªŒè¯';
                }
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.textContent = 'âŒ éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•';
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'éªŒè¯';
            }
        }

        // æ£€æŸ¥éªŒè¯çŠ¶æ€
        async function checkVerificationStatus() {
            const uid = getPlayerUid();
            if (!uid) return false;

            // 1. å…ˆæ£€æŸ¥ç”¨æˆ·è´¦æˆ·ä¸­çš„å·²éªŒè¯UIDï¼ˆæ°¸ä¹…éªŒè¯ï¼‰
            const verifiedUids = JSON.parse(localStorage.getItem('verifiedUids') || '[]');
            if (verifiedUids.includes(uid)) {
                console.log('UIDå·²åœ¨è´¦æˆ·ä¸­æ°¸ä¹…éªŒè¯');
                updateVerificationUI(true);
                return true;
            }

            // 2. æ£€æŸ¥ä¸´æ—¶éªŒè¯çŠ¶æ€ï¼ˆ5åˆ†é’ŸlocalStorageï¼‰
            const saved = localStorage.getItem('verification');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.uid === uid && data.verified) {
                    const expiryTime = new Date(data.expiryTime);
                    if (new Date() < expiryTime) {
                        // éªŒè¯ä»ç„¶æœ‰æ•ˆ
                        updateVerificationUI(true);
                        return true;
                    } else {
                        // éªŒè¯å·²è¿‡æœŸ
                        localStorage.removeItem('verification');
                    }
                }
            }

            // 3. å‘æœåŠ¡å™¨ç¡®è®¤ï¼ˆåå¤‡æ£€æŸ¥ï¼‰
            try {
                const response = await fetch(`/api/verification/status?uid=${uid}`);
                const result = await response.json();

                if (result.verified) {
                    updateVerificationUI(true);
                    return true;
                } else {
                    updateVerificationUI(false);
                    return false;
                }
            } catch (error) {
                console.error('æ£€æŸ¥éªŒè¯çŠ¶æ€å¤±è´¥:', error);
                return false;
            }
        }

        // æ›´æ–°éªŒè¯UIçŠ¶æ€
        function updateVerificationUI(verified) {
            const statusDiv = document.getElementById('verification-status');
            const codeInput = document.getElementById('verification-code');
            const sendBtn = document.getElementById('send-code-btn');
            const verifyBtn = document.getElementById('verify-code-btn');

            if (verified) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';

                // æ£€æŸ¥å½“å‰UIDæ˜¯å¦åœ¨è´¦æˆ·çš„æ°¸ä¹…éªŒè¯åˆ—è¡¨ä¸­
                const currentUid = document.getElementById('player-uid').value.trim();
                const verifiedUids = JSON.parse(localStorage.getItem('verifiedUids') || '[]');

                if (verifiedUids.includes(currentUid)) {
                    // æ°¸ä¹…éªŒè¯
                    statusDiv.textContent = 'âœ… æ­¤UIDå·²æ°¸ä¹…éªŒè¯ï¼ˆå·²ç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·ï¼‰';
                } else {
                    // ä¸´æ—¶éªŒè¯ï¼Œæ£€æŸ¥å‰©ä½™æ—¶é—´
                    const saved = localStorage.getItem('verification');
                    if (saved) {
                        const data = JSON.parse(saved);
                        const expiryTime = new Date(data.expiryTime);
                        const now = new Date();
                        const remainingMinutes = Math.ceil((expiryTime - now) / 60000);

                        if (remainingMinutes > 0) {
                            statusDiv.textContent = `âœ… ä¸´æ—¶éªŒè¯ï¼ˆå‰©ä½™ ${remainingMinutes} åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰`;
                        } else {
                            statusDiv.textContent = 'âœ… å·²éªŒè¯';
                        }
                    } else {
                        statusDiv.textContent = 'âœ… å·²éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨è¿œç¨‹æŒ‡ä»¤';
                    }
                }

                // ä¸ç¦ç”¨è¾“å…¥æ¡†ï¼Œè¿™æ ·5åˆ†é’Ÿåå¯ä»¥é‡æ–°éªŒè¯
                codeInput.value = '';
                verifyBtn.textContent = 'å·²éªŒè¯';
            } else {
                statusDiv.style.display = 'none';
                codeInput.disabled = false;
                codeInput.value = '';
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€éªŒè¯ç ';
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'éªŒè¯';
            }
        }

        // ç‚¹èµæŒ‡ä»¤ï¼ˆéœ€è¦UIDï¼‰
        async function likePlayerCommand(id) {
            const uid = getPlayerUid();
            if (!uid) return;

            try {
                const response = await fetch(`/api/commands/${id}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid })
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… ' + result.message);
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadCommunityCommands(currentCommunityType);
                } else {
                    alert('âŒ ' + result.message);
                }
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
                alert('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ä½¿ç”¨æŒ‡ä»¤ï¼ˆç›´æ¥å‘é€åˆ°ç©å®¶è´¦æˆ·ï¼‰
        async function usePlayerCommand(id, command) {
            const uid = getPlayerUid();
            if (!uid) return;

            // æ£€æŸ¥éªŒè¯çŠ¶æ€ï¼ˆä¸å¼¹çª—ï¼Œé™é»˜æ£€æŸ¥ï¼‰
            const verified = await checkVerificationStatus();
            if (!verified) {
                // æ˜¾ç¤ºå‹å¥½çš„æç¤ºæ¶ˆæ¯ï¼ˆåœ¨é¡µé¢é¡¶éƒ¨æ»šåŠ¨ï¼‰
                const uidManagementSection = document.querySelector('[style*="UIDç®¡ç†"]')?.parentElement;
                if (uidManagementSection) {
                    uidManagementSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // ä½¿ç”¨confirmæç¤ºï¼Œä½†æ›´ç®€æ´
                const shouldProceed = confirm('âš ï¸ å½“å‰UIDæœªéªŒè¯\n\næ˜¯å¦å‰å¾€é¡¶éƒ¨æ·»åŠ å¹¶éªŒè¯æ­¤UIDï¼Ÿ\n\nUID: ' + uid);
                if (shouldProceed) {
                    // æ»šåŠ¨åˆ°UIDç®¡ç†åŒºåŸŸ
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    // å°†UIDå¡«å…¥æ–°UIDè¾“å…¥æ¡†
                    document.getElementById('new-uid-input').value = uid;
                    // èšç„¦åˆ°è¾“å…¥æ¡†
                    setTimeout(() => {
                        document.getElementById('new-uid-input').focus();
                    }, 500);
                }
                return;
            }

            if (!confirm('ç¡®è®¤è¦å°†æ­¤æŒ‡ä»¤å‘é€åˆ°æ‚¨çš„æ¸¸æˆè´¦æˆ·å—ï¼Ÿ\n\nUID: ' + uid + '\næŒ‡ä»¤: ' + command)) {
                return;
            }

            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const response = await fetch(`/api/commands/${id}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid, sessionToken })
                });

                const result = await response.json();

                if (result.success) {
                    alert('âœ… æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸï¼\n\n' + (result.data || 'æŒ‡ä»¤å·²å‘é€åˆ°æ‚¨çš„è´¦æˆ·'));
                } else {
                    if (result.needVerification) {
                        alert('âš ï¸ ' + result.message + '\n\nè¯·é‡æ–°éªŒè¯ï¼š\n1. ç¡®ä¿æ¸¸æˆåœ¨çº¿\n2. ç‚¹å‡»"å‘é€éªŒè¯ç "æŒ‰é’®\n3. åœ¨æ¸¸æˆä¸­æŸ¥çœ‹å¥½å‹æ¶ˆæ¯ä¸­çš„4ä½éªŒè¯ç \n4. åœ¨1åˆ†é’Ÿå†…è¾“å…¥éªŒè¯ç å¹¶ç‚¹å‡»éªŒè¯\n\næç¤ºï¼šéªŒè¯æˆåŠŸåï¼Œå·²éªŒè¯çŠ¶æ€å°†ä¿æŒ5åˆ†é’Ÿ');
                        // æ¸…é™¤æœ¬åœ°éªŒè¯çŠ¶æ€
                        localStorage.removeItem('verification');
                        updateVerificationUI(false);
                    } else {
                        alert('âŒ ' + result.message);
                    }
                }
            } catch (error) {
                console.error('æ‰§è¡ŒæŒ‡ä»¤å¤±è´¥:', error);
                alert('æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            }
        }
    </script>
</body>
</html>